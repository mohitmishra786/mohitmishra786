name: Commit Statistics

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly
  workflow_dispatch:

jobs:
  update-commit-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Generate Commit Stats
        run: |
          python3 << 'EOF'
          import subprocess
          import json
          from datetime import datetime, timedelta
          
          # Get commits from last year
          one_year_ago = (datetime.now() - timedelta(days=365)).strftime('%Y-%m-%d')
          # %ai gives ISO 8601 format: 2020-09-01 12:00:00 +0000
          result = subprocess.run(
              ['git', 'log', f'--since={one_year_ago}', '--format=%ai|%an', '--all'],
              capture_output=True, text=True
          )
          
          commits = result.stdout.strip().split('\n')
          stats = {
              'total_commits': len(commits),
              'commits_by_day': {},
              'commits_by_hour': {},
              'commits_by_month': {}
          }
          
          for commit in commits:
              if '|' not in commit:
                  continue
              date_str, author = commit.split('|')
              try:
                  # Parse 2020-09-01 12:00:00 +0000
                  dt = datetime.strptime(date_str, '%Y-%m-%d %H:%M:%S %z')
                  
                  day = dt.strftime('%A')
                  hour = dt.hour
                  month = dt.strftime('%B %Y')
                  
                  stats['commits_by_day'][day] = stats['commits_by_day'].get(day, 0) + 1
                  stats['commits_by_hour'][hour] = stats['commits_by_hour'].get(hour, 0) + 1
                  stats['commits_by_month'][month] = stats['commits_by_month'].get(month, 0) + 1
              except ValueError:
                  continue
          
          # Generate markdown
          md = "## Commit Analytics\n\n"
          md += f"**Total Commits (Last Year):** {stats['total_commits']:,}\n\n"
          
          md += "### Commits by Day of Week\n"
          days_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
          for day in days_order:
              count = stats['commits_by_day'].get(day, 0)
              bar = 'â–ˆ' * (count // 10 if count > 0 else 0)
              if not bar: bar = 'â–‘'
              md += f"{day}: {bar} ({count})  \n"
          
          md += "\n### Most Active Hours\n"
          for hour in sorted(stats['commits_by_hour'].keys(), key=lambda x: stats['commits_by_hour'][x], reverse=True)[:5]:
              count = stats['commits_by_hour'][hour]
              md += f"{hour:02d}:00 - {count} commits  \n"
          
          with open('COMMIT_STATS.md', 'w') as f:
              f.write(md)
          EOF
      
      - name: Update README
        run: |
          if [ -f COMMIT_STATS.md ]; then
            sed -i '/<!--START_COMMITS-->/,/<!--END_COMMITS-->/!b; /<!--START_COMMITS-->/!d; r COMMIT_STATS.md' README.md
          fi
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          if ! git diff-index --quiet HEAD --; then
             git commit -m "ðŸ“Š Update commit statistics"
             git push
          fi
