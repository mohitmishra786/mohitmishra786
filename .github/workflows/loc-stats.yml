name: Lines of Code Stats

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:

jobs:
  update-loc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Update LOC Stats
        id: loc
        run: |
          # Fetch JSON from CodeTabs with correct repo path
          if ! curl -L "https://api.codetabs.com/v1/loc?github=mohitmishra786/mohitmishra786" > loc-stats.json; then
             echo "Failed to fetch LOC stats"
             exit 1
          fi
          
          python3 << 'EOF'
          import json
          import sys
          import os

          try:
              with open('loc-stats.json', 'r') as f:
                  data = json.load(f)
          except Exception as e:
              print(f"Error reading JSON: {e}")
              sys.exit(0)

          if isinstance(data, list):
              markdown = "## Lines of Code Statistics\n\n"
              markdown += "| Language | Files | Lines | Code | Comments | Blanks |\n"
              markdown += "|----------|-------|-------|------|----------|--------|\n"
              
              total = {'files': 0, 'lines': 0, 'code': 0, 'comments': 0, 'blanks': 0}
              
              for item in data:
                  lang = item.get('language', 'Unknown')
                  files = item.get('files', 0)
                  lines = item.get('lines', 0)
                  code = item.get('linesOfCode', 0)
                  comments = item.get('comments', 0)
                  blanks = item.get('blanks', 0)
                  
                  markdown += f"| {lang} | {files:,} | {lines:,} | {code:,} | {comments:,} | {blanks:,} |\n"
                  if lang != 'Total':
                      total['files'] += files
                      total['lines'] += lines
                      total['code'] += code
                      total['comments'] += comments
                      total['blanks'] += blanks
              
              # Use calculated total if "Total" entry is missing or double check
              markdown += f"| **Total** | **{total['files']:,}** | **{total['lines']:,}** | **{total['code']:,}** | **{total['comments']:,}** | **{total['blanks']:,}** |\n"
              
              # Read README
              with open('README.md', 'r') as f:
                  content = f.read()

              start_marker = "<!--START_LOC-->"
              end_marker = "<!--END_LOC-->"
              
              if start_marker in content and end_marker in content:
                  start_idx = content.find(start_marker) + len(start_marker)
                  end_idx = content.find(end_marker)
                  
                  new_content = content[:start_idx] + "\n" + markdown + "\n" + content[end_idx:]
                  
                  with open('README.md', 'w') as f:
                      f.write(new_content)
                  print("Updated README.md")
              else:
                  print("Markers not found in README.md")
          else:
              print("Invalid data format received from API")
          EOF
          rm -f loc-stats.json
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if ! git diff-index --quiet HEAD --; then
             git commit -m "Update LOC statistics"
             git pull origin main --rebase --autostash
             git push
          fi
