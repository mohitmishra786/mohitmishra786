name: Lines of Code Stats

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:

jobs:
  update-loc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Fetch LOC Stats
        run: |
          # Fetch JSON from CodeTabs
          if ! curl -L "https://api.codetabs.com/v1/loc?github=mohitmishra786" > loc-stats.json; then
             echo "Failed to fetch LOC stats"
             exit 1
          fi
          
      - name: Generate LOC Markdown
        run: |
          python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('loc-stats.json', 'r') as f:
                  data = json.load(f)
          except json.JSONDecodeError:
              print("Invalid JSON received")
              sys.exit(0) # Exit gracefully if API returns garbage
          
          # If API returns an error list instead of list of dicts with language
          if isinstance(data, list) and len(data) > 0 and 'language' not in data[0]:
               print("Unexpected data format")
               sys.exit(0)

          markdown = "## Lines of Code Statistics\n\n"
          markdown += "| Language | Files | Lines | Code | Comments | Blanks |\n"
          markdown += "|----------|-------|-------|------|----------|--------|\n"
          
          total = {'files': 0, 'lines': 0, 'code': 0, 'comments': 0, 'blanks': 0}
          
          # Ensure data is a list
          if isinstance(data, list):
              for item in data:
                  lang = item.get('language', 'Unknown')
                  files = item.get('files', 0)
                  lines = item.get('lines', 0)
                  code = item.get('linesOfCode', 0)
                  comments = item.get('comments', 0)
                  blanks = item.get('blanks', 0)
                  
                  markdown += f"| {lang} | {files:,} | {lines:,} | {code:,} | {comments:,} | {blanks:,} |\n"
                  total['files'] += files
                  total['lines'] += lines
                  total['code'] += code
                  total['comments'] += comments
                  total['blanks'] += blanks
              
              markdown += f"| **Total** | **{total['files']:,}** | **{total['lines']:,}** | **{total['code']:,}** | **{total['comments']:,}** | **{total['blanks']:,}** |\n"
              
              with open('LOC_STATS.md', 'w') as f:
                  f.write(markdown)
          else:
              print("Data is not a list")
          EOF
      
      - name: Update README with LOC
        run: |
          if [ -f LOC_STATS.md ]; then
            sed -i '/<!--START_LOC-->/,/<!--END_LOC-->/!b; /<!--START_LOC-->/!d; r LOC_STATS.md' README.md
          fi
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          if ! git diff-index --quiet HEAD --; then
             git pull --rebase
             git commit -m "Update LOC statistics"
             git push
          fi
